---
title: "Results of preprocessing"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Import libraries
library(readr)
library(tidyverse)
library(gridExtra)
```

## Adapters trimmed by fastp
```{r, include=FALSE}
# Read in the data
fastp_path <- file.path(snakemake@input[["fastp"]])
fastp <- read_tsv(fastp_path) %>%
  mutate(percent_adapter_trimmed = (adapter_cutting.adapter_trimmed_reads/summary.before_filtering.total_reads)*100)
```

```{r, echo=FALSE, warning=FALSE}
# Create the boxplot with data validation
fastp_clean <- fastp %>%
  mutate(percent_adapter_trimmed = pmax(0, pmin(100, percent_adapter_trimmed)))

ggplot(fastp_clean, aes(x="", y=percent_adapter_trimmed))+
  geom_boxplot(outlier.shape=NA)+
  geom_jitter(width=0.2) +
  theme_bw() +
  ylab("Percent of reads trimmed") +
  xlab("") +
  scale_y_continuous(limits = c(0, 100)) +
  labs(title="Adapter trimming")
```

## PrimerB contamination removal
```{r, echo=FALSE, warning=FALSE}
# Read in the data
primer_b_path <- file.path(snakemake@input[["primer_b"]])
primer_b <- read_tsv(primer_b_path)

# Clean data and ensure valid percentages
primer_b_clean <- primer_b %>%
  mutate(
    percent_with_primerB = pmax(0, pmin(100, percent_with_primerB)),
    percent_with_primerB_rc = pmax(0, pmin(100, percent_with_primerB_rc)),
    percent_total_primerB = pmax(0, pmin(100, percent_total_primerB))
  )

# Boxplots with adjusted y-axis scale
# First, determine the appropriate y-axis limit based on the data
max_percent <- max(c(primer_b_clean$percent_with_primerB, 
                    primer_b_clean$percent_with_primerB_rc, 
                    primer_b_clean$percent_total_primerB)) * 1.1  # Add 10% margin

# Create improved boxplots with adjusted scale
p1 <- ggplot(primer_b_clean, aes(x="", y=percent_with_primerB)) +
  geom_boxplot(outlier.shape=NA) +
  geom_jitter(width=0.2, alpha=0.6) +
  theme_bw() +
  ylab("Percent of reads") +
  xlab("") +
  scale_y_continuous(limits = c(0, max_percent)) +  # Adjusted scale
  labs(title="PrimerB contamination")

p2 <- ggplot(primer_b_clean, aes(x="", y=percent_with_primerB_rc)) +
  geom_boxplot(outlier.shape=NA) +
  geom_jitter(width=0.2, alpha=0.6) +
  theme_bw() +
  ylab("Percent of reads") +
  xlab("") +
  scale_y_continuous(limits = c(0, max_percent)) +  # Adjusted scale
  labs(title="PrimerB_rc contamination")

# Display the plots side by side with adjusted scales
grid.arrange(p1, p2, ncol=2)

# Plot total PrimerB contamination with adjusted scale
ggplot(primer_b_clean, aes(x="", y=percent_total_primerB)) +
  geom_boxplot(outlier.shape=NA) +
  geom_jitter(width=0.2, alpha=0.6) +
  theme_bw() +
  ylab("Percent of reads with PrimerB") +
  xlab("") +
  scale_y_continuous(limits = c(0, max_percent)) +  # Adjusted scale
  labs(title="Total PrimerB contamination")

## Vector contamination removal
```{r, echo=FALSE, warning=FALSE}
vector_data <- read_tsv(snakemake@input[[1]])

# Generate a boxplot for percentage of reads with vector contamination
# Colored by the top vector present
ggplot(vector_data, aes(x = "", y = percent_with_vector, color = top_vector)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(width = 0.2, alpha = 0.6) +
  theme_bw() +
  ylab("Percent of reads with vector contamination") +
  xlab("") +
  labs(title = "Vector Contamination in Reads") +
  scale_color_discrete(name = "Top Vector")
```

## BBMerge read merging statistics
```{r, include=FALSE}
# Read in the data
bbmerge_path <- file.path(snakemake@input[["bbmerge"]])
bbmerge <- read_tsv(bbmerge_path)

# Read in the histogram data
bbmerge_hist_path <- file.path(snakemake@input[["bbmerge_hist"]])
bbmerge_hist <- read_tsv(bbmerge_hist_path)
```

```{r, echo=FALSE, warning=FALSE}
# Create the plot for percent merged with data validation
bbmerge_clean <- bbmerge %>%
  mutate(percent_merged = pmax(0, pmin(100, percent_merged)))

ggplot(bbmerge_clean, aes(x="", y=percent_merged))+
  geom_boxplot(outlier.shape=NA)+
  geom_jitter(width=0.2) +
  theme_bw() +
  ylab("Percent of read pairs merged") +
  xlab("") +
  scale_y_continuous(limits = c(0, 100)) +
  labs(title="Read merging rate")

# Create a plot for average insert size
ggplot(bbmerge, aes(x="", y=avg_insert_size))+
  geom_boxplot(outlier.shape=NA)+
  geom_jitter(width=0.2) +
  theme_bw() +
  ylab("Average insert size (bp)") +
  xlab("") +
  labs(title="Insert size distribution")

# Create insert size histogram for a representative sample
# First, melt the histogram data
bbmerge_hist_long <- bbmerge_hist %>%
  rownames_to_column(var = "insert_size") %>%
  mutate(insert_size = as.numeric(insert_size)) %>%
  pivot_longer(
    cols = -insert_size,
    names_to = "sample",
    values_to = "count"
  ) %>%
  filter(count > 0 & insert_size > 0 & insert_size < 1000)  # Filter out zeros and extreme values

# Select a representative sample (highest total count)
sample_counts <- bbmerge_hist_long %>%
  group_by(sample) %>%
  summarize(total = sum(count)) %>%
  arrange(desc(total))

if (nrow(sample_counts) > 0) {
  rep_sample <- sample_counts$sample[1]
  
  # Plot the histogram for the representative sample
  bbmerge_hist_long %>%
    filter(sample == rep_sample) %>%
    ggplot(aes(x = insert_size, y = count)) +
    geom_line() +
    theme_bw() +
    labs(
      title = paste("Insert size distribution for sample", rep_sample),
      x = "Insert size (bp)",
      y = "Count"
    )
}
```

## Host removal statistics
```{r, include=FALSE}
# Read in the data
host_path <- file.path(snakemake@input[["host"]])
host <- read_tsv(host_path)
```

```{r, echo=FALSE, warning=FALSE}
# Create plots for host removal
# Add data validation to ensure percentages are within valid range (0-100)
host_clean <- host %>%
  mutate(
    percent_host_in_merged = pmax(0, pmin(100, percent_host_in_merged)),
    percent_host_in_unmerged = pmax(0, pmin(100, percent_host_in_unmerged)),
    percent_host_overall = pmax(0, pmin(100, percent_host_overall))
  )

p1 <- ggplot(host_clean, aes(x="", y=percent_host_in_merged))+
  geom_boxplot(outlier.shape=NA)+
  geom_jitter(width=0.2) +
  theme_bw() +
  ylab("Percent host reads") +
  xlab("") +
  scale_y_continuous(limits = c(0, 100)) +
  labs(title="Host DNA in merged reads")

p2 <- ggplot(host_clean, aes(x="", y=percent_host_in_unmerged))+
  geom_boxplot(outlier.shape=NA)+
  geom_jitter(width=0.2) +
  theme_bw() +
  ylab("Percent host reads") +
  xlab("") +
  scale_y_continuous(limits = c(0, 100)) +
  labs(title="Host DNA in unmerged reads")

# Display the plots side by side
grid.arrange(p1, p2, ncol=2)

# Plot overall host contamination
ggplot(host_clean, aes(x="", y=percent_host_overall))+
  geom_boxplot(outlier.shape=NA)+
  geom_jitter(width=0.2) +
  theme_bw() +
  ylab("Percent of reads mapped to host") +
  xlab("") +
  scale_y_continuous(limits = c(0, 100)) +
  labs(title="Overall host contamination")
```

## Summary of preprocessing
```{r, echo=FALSE, warning=FALSE}
# Create a summary table of all preprocessing steps
summary_data <- data.frame(
  Step = c(
    "Adapter trimming (fastp)", 
    "PrimerB contamination", 
    "Vector contamination", 
    "Reads merged (BBMerge)", 
    "Host contamination"
  ),
  Mean_percent = c(
    mean(fastp_clean$percent_adapter_trimmed),
    mean(primer_b_clean$percent_total_primerB),
    mean(vector_clean$percent_with_vector),
    mean(bbmerge_clean$percent_merged),
    mean(host_clean$percent_host_overall)
  ),
  Median_percent = c(
    median(fastp_clean$percent_adapter_trimmed),
    median(primer_b_clean$percent_total_primerB),
    median(vector_clean$percent_with_vector),
    median(bbmerge_clean$percent_merged),
    median(host_clean$percent_host_overall)
  ),
  Min_percent = c(
    min(fastp_clean$percent_adapter_trimmed),
    min(primer_b_clean$percent_total_primerB),
    min(vector_clean$percent_with_vector),
    min(bbmerge_clean$percent_merged),
    min(host_clean$percent_host_overall)
  ),
  Max_percent = c(
    max(fastp_clean$percent_adapter_trimmed),
    max(primer_b_clean$percent_total_primerB),
    max(vector_clean$percent_with_vector),
    max(bbmerge_clean$percent_merged),
    max(host_clean$percent_host_overall)
  )
)

# Format percentages to two decimal places
summary_data[, 2:5] <- round(summary_data[, 2:5], 2)

# Add a row for the final "kept reads" percentage (estimate)
kept_percent <- 100 - mean(host_clean$percent_host_overall)
summary_data <- rbind(
  summary_data,
  data.frame(
    Step = "Reads kept after all steps (estimate)",
    Mean_percent = round(kept_percent, 2),
    Median_percent = NA,
    Min_percent = NA,
    Max_percent = NA
  )
)

# Display the summary table
knitr::kable(summary_data, 
             caption = "Summary statistics for preprocessing steps",
             col.names = c("Preprocessing step", "Mean %", "Median %", "Min %", "Max %"))
```
